<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Inherit the Job Position "Configuration" form view -->
        <record id="hr_job_view_form_inherit_bulk_openai" model="ir.ui.view">
            <field name="name">hr.job.form.inherit.bulk.openai</field>
            <field name="model">hr.job</field>
            <!-- 
                Inherit the base 'hr.view_hr_job_form', which is
                the view used when clicking "Configuration" on the kanban card.
            -->
            <field name="inherit_id" ref="hr.view_hr_job_form"/>
            <field name="priority">99</field>
            <field name="arch" type="xml">
                
                <xpath expr="//notebook" position="inside">
                    <page string="Bulk CV Processing (OpenAI)" name="bulk_cv_processing">
                        <group>
                            <group>
                                <field name="cv_attachment_ids"
                                       widget="many2many_binary"
                                       string="CVs to Process"
                                       readonly="processing_in_progress"/>
                                <field name="processed_cv_attachment_ids"
                                       widget="many2many_tags"
                                       string="Successfully Processed CVs"
                                       readonly="1"
                                       nolabel="0"
                                       invisible="not processed_cv_attachment_ids"/>
                            </group>
                            <group>
                                <button name="action_process_cvs"
                                        type="object"
                                        string="Add Candidates from CVs"
                                        class="oe_highlight"
                                        invisible="not cv_attachment_ids or processing_in_progress"
                                        help="Process all attached CVs that have not yet been successfully processed."/>
                                
                                <button name="action_delete_cv_attachments"
                                        type="object"
                                        string="Delete Attached CVs"
                                        class="btn-danger"
                                        confirm="Are you sure you want to delete all uploaded CV attachments for this job? This action cannot be undone."
                                        invisible="processing_in_progress"
                                        help="Delete all CVs from the 'CVs to Process' and 'Successfully Processed CVs' fields and reset all counters."/>

                                <!-- Progress Bar -->
                                <div class="o_form_label" 
                                     invisible="not processing_in_progress">
                                    <strong>Processing...</strong>
                                </div>
                                <div invisible="not processing_in_progress">
                                    <span>
                                        <i class="fa fa-spinner fa-spin"/>
                                        Please wait. New applicants are being created.
                                    </span>
                                    <field name="processing_progress" widget="progressbar"/>
                                    <div class="o_form_label">
                                        <span>Processed: <field name="processed_cv_count" class="oe_inline"/></span>
                                        <span class="text-danger" invisible="failed_cv_count == 0">
                                            , Failed: <field name="failed_cv_count" class="oe_inline"/>
                                        </span>
                                        <span>/ <field name="total_cv_count" class="oe_inline"/></span>
                                    </div>
                                </div>
                                
                                <!-- Success Message -->
                                <div class="text-muted" 
                                     invisible="processing_in_progress or not processing_complete or processing_failed">
                                    <strong>Processing Complete.</strong>
                                    <br/>
                                    <span class="oe_inline"><field name="processed_cv_count" class="oe_inline"/></span> CVs processed successfully.
                                    <br/>
                                    You can now delete the attached files.
                                </div>
                                
                                <!-- Failure Message -->
                                <div class="text-danger" 
                                     invisible="processing_in_progress or not processing_failed">
                                    <strong>Processing Finished with Errors.</strong>
                                    <br/>
                                    <span class="oe_inline"><field name="processed_cv_count" class="oe_inline"/></span> succeeded, 
                                    <span class="oe_inline"><field name="failed_cv_count" class="oe_inline"/></span> failed.
                                    <br/>
                                    You can click "Add Candidates" to retry the failed files, or delete all files to start over.
                                </div>
                            </group>
                        </group>
                        
                        <!-- 
                            Technical fields for 'invisible' and 'readonly' attributes.
                        -->
                        <field name="processing_in_progress" invisible="1"/>
                        <field name="processing_complete" invisible="1"/>
                        <field name="processing_failed" invisible="1"/>
                        <field name="queue_job_uuid" invisible="1"/>
                        <field name="job_state" invisible="1"/>
                        <field name="processed_cv_count" invisible="1"/>
                        <field name="failed_cv_count" invisible="1"/>
                        <field name="total_cv_count" invisible="1"/>
                    </page>
                </xpath>
            </field>
        </record>

    </data>
</odoo>